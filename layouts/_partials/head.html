<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="{{.Description | default .Site.Params.SiteDescription}}">

{{ hugo.Generator }}

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="{{ "favicon.ico" | relURL }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ "favicon-16x16.png" | relURL }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ "favicon-32x32.png" | relURL }}">
<link rel="apple-touch-icon" sizes="180x180" href="{{ "apple-touch-icon.png" | relURL }}">
<link rel="manifest" href="{{ "site.webmanifest" | relURL }}">

<!-- Permalink & RSSlink -->
<link rel="canonical" href="{{ .Permalink }}" >
{{- with .OutputFormats.Get "RSS" }}
  <link href="{{ .Permalink }}" rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}" >
  <link href="{{ .Permalink }}" rel="feed" type="application/rss+xml" title="{{ $.Site.Title }}" >
{{- end -}}

{{ $options := dict
  "targetPath" "css/style.css"
  "transpiler" "dartsass"
}}

{{ $style := resources.Get "main.scss" | toCSS $options | minify | fingerprint }}
<link href="{{ $style.RelPermalink }}" rel="stylesheet">

<!-- Notification System Script -->
<script>
(function() {
    // Notification system
    window.showNotification = function(message) {
        // Get or create container
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.className = 'notification-container';
            document.body.appendChild(container);
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-prompt">></span>
                <span class="notification-message">${message}</span>
            </div>
        `;
        
        container.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            notification.classList.add('hiding');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    };
})();
</script>

<!-- Navigation Keybindings Script -->
<script>
(function() {
    function handleNavigationKeys(e) {
        // Ignore if user is typing in an input/textarea
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }
        
        // Ignore if modifier keys are pressed
        if (e.ctrlKey || e.metaKey || e.altKey) {
            return;
        }
        
        // Check if theme terminal or search modal is open
        const themeTerminal = document.getElementById('theme-terminal');
        const isTerminalOpen = themeTerminal && themeTerminal.classList.contains('active');
        const searchModal = document.getElementById('search-modal');
        const isSearchOpen = searchModal && searchModal.classList.contains('active');
        
        // Don't handle any navigation when search is open
        if (isSearchOpen) {
            return;
        }
        
        // Don't handle scrolling when terminal is open
        if (isTerminalOpen && (e.key === 'j' || e.key === 'k' || e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
            return;
        }
        
        const key = e.key;
        const baseURL = window.location.origin + '/';
        let handled = false;
        
        // Skip '/' key - it's used for search
        if (key === '/') {
            return;
        }
        
        // Scrolling with j/k and arrow keys
        const scrollAmount = 100; // pixels to scroll
        if (key === 'j' || key === 'ArrowDown') {
            window.scrollBy({ top: scrollAmount, behavior: 'smooth' });
            handled = true;
        } else if (key === 'k' || key === 'ArrowUp') {
            window.scrollBy({ top: -scrollAmount, behavior: 'smooth' });
            handled = true;
        }
        
        // Navigation keys
        switch(key.toLowerCase()) {
            case 'g':
                window.location.href = baseURL;
                handled = true;
                break;
            case 'w':
                window.location.href = baseURL + 'about/';
                handled = true;
                break;
            case 'b':
                window.location.href = baseURL + 'blog/';
                handled = true;
                break;
            case 'p':
                window.location.href = baseURL + 'portfolio/';
                handled = true;
                break;
            case 't':
                const themeSwitcher = document.querySelector('.theme-switcher button');
                if (themeSwitcher) {
                    themeSwitcher.click();
                    handled = true;
                }
                break;
        }
        
        if (handled) {
            e.preventDefault();
            e.stopPropagation();
        }
    }
    
    // Use both DOMContentLoaded and immediate execution
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', handleNavigationKeys, true);
        });
    } else {
        document.addEventListener('keydown', handleNavigationKeys, true);
    }
})();
</script>

<!-- Notification Styles -->
<style>
.notification-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
}

.notification {
    background: var(--bg-darker);
    border: 2px solid var(--border-color);
    border-left: 4px solid var(--accent-secondary);
    padding: 12px 16px;
    font-family: 'Fira Mono', monospace;
    font-size: 0.85rem;
    color: var(--text-primary);
    min-width: 250px;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    animation: slideIn 0.3s ease-out;
    pointer-events: auto;
}

.notification.hiding {
    animation: slideOut 0.3s ease-out forwards;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 8px;
}

.notification-prompt {
    color: var(--prompt-user);
    font-weight: bold;
}

.notification-message {
    color: var(--text-primary);
}

@keyframes slideIn {
    from {
        transform: translateX(120%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(120%);
        opacity: 0;
    }
}

@media screen and (max-width: 600px) {
    .notification-container {
        bottom: 10px;
        right: 10px;
        left: 10px;
    }
    
    .notification {
        min-width: auto;
        max-width: none;
    }
}
</style>

<!-- Pagefind CSS and JS -->
<link href="{{ "pagefind/pagefind-ui.css" | relURL }}" rel="stylesheet">
<script src="{{ "pagefind/pagefind-ui.js" | relURL }}"></script>

<!-- Search Modal Script -->
<script>
(function() {
    let pagefindInstance = null;
    let selectedResultIndex = -1;
    let resultLinks = [];
    
    function initializeSearch() {
        if (pagefindInstance) return;
        
        pagefindInstance = new PagefindUI({
            element: "#search-container",
            showSubResults: true,
            showImages: false,
            excerptLength: 15,
            processResult: function(result) {
                // Ensure results are clickable and close modal on click
                return result;
            }
        });
        
        // Close modal when clicking on search results
        setTimeout(() => {
            const searchContainer = document.getElementById('search-container');
            if (searchContainer) {
                searchContainer.addEventListener('click', function(e) {
                    // Check if clicked element is a link or inside a result
                    const link = e.target.closest('a');
                    if (link && link.href) {
                        closeSearchModal();
                    }
                });
                
                // Update result links after search completes
                updateResultLinks();
                
                // Watch for changes in search results
                const observer = new MutationObserver(function() {
                    updateResultLinks();
                });
                observer.observe(searchContainer, { childList: true, subtree: true });
            }
        }, 500);
    }
    
    function updateResultLinks() {
        resultLinks = Array.from(document.querySelectorAll('.pagefind-ui__result-link, .pagefind-ui__button'));
        selectedResultIndex = -1;
        clearSelection();
    }
    
    function clearSelection() {
        resultLinks.forEach(link => {
            link.classList.remove('keyboard-selected');
            const resultCard = link.closest('.pagefind-ui__result');
            if (resultCard) {
                resultCard.classList.remove('keyboard-selected');
            }
        });
    }
    
    function selectResult(index) {
        if (resultLinks.length === 0) return;
        
        clearSelection();
        
        // Wrap around
        if (index < 0) index = resultLinks.length - 1;
        if (index >= resultLinks.length) index = 0;
        
        selectedResultIndex = index;
        const selectedLink = resultLinks[selectedResultIndex];
        
        if (selectedLink) {
            selectedLink.classList.add('keyboard-selected');
            const resultCard = selectedLink.closest('.pagefind-ui__result');
            if (resultCard) {
                resultCard.classList.add('keyboard-selected');
            }
            selectedLink.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    function navigateToSelected() {
        if (selectedResultIndex >= 0 && resultLinks[selectedResultIndex]) {
            const element = resultLinks[selectedResultIndex];
            
            // If it's a button, click it instead of navigating
            if (element.classList.contains('pagefind-ui__button')) {
                element.click();
                clearSelection();
                selectedResultIndex = -1;
            } else {
                // It's a link, navigate to it
                closeSearchModal();
                window.location.href = element.href;
            }
        }
    }
    
    function openSearchModal() {
        const modal = document.getElementById('search-modal');
        if (modal) {
            modal.classList.add('active');
            initializeSearch();
            selectedResultIndex = -1;
            // Focus on the search input after a short delay
            setTimeout(() => {
                const searchInput = document.querySelector('.pagefind-ui__search-input');
                if (searchInput) searchInput.focus();
            }, 100);
        }
    }
    
    function closeSearchModal() {
        const modal = document.getElementById('search-modal');
        if (modal) {
            modal.classList.remove('active');
            clearSelection();
            selectedResultIndex = -1;
        }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setupSearchHandlers();
        });
    } else {
        setupSearchHandlers();
    }
    
    function setupSearchHandlers() {
        const searchButton = document.getElementById('search-button');
        const searchClose = document.getElementById('search-close');
        const searchModal = document.getElementById('search-modal');
        
        if (searchButton) {
            searchButton.addEventListener('click', openSearchModal);
        }
        
        if (searchClose) {
            searchClose.addEventListener('click', closeSearchModal);
        }
        
        if (searchModal) {
            // Close modal when clicking outside
            searchModal.addEventListener('click', function(e) {
                if (e.target === searchModal) {
                    closeSearchModal();
                }
            });
        }
        
        // Global keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            const isSearchOpen = searchModal && searchModal.classList.contains('active');
            
            // Don't trigger if already typing in an input (except in search modal)
            if (!isSearchOpen && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                return;
            }
            
            // Open search with '/' key
            if (e.key === '/' && !isSearchOpen) {
                e.preventDefault();
                openSearchModal();
                return;
            }
            
            // Handle keys when search is open
            if (isSearchOpen) {
                switch(e.key) {
                    case 'Escape':
                        e.preventDefault();
                        closeSearchModal();
                        break;
                    case 'ArrowDown':
                    case 'j':
                        if (e.key === 'j' && !e.ctrlKey) break; // Only Ctrl+J
                        e.preventDefault();
                        selectResult(selectedResultIndex + 1);
                        break;
                    case 'ArrowUp':
                    case 'k':
                        if (e.key === 'k' && !e.ctrlKey) break; // Only Ctrl+K
                        e.preventDefault();
                        selectResult(selectedResultIndex - 1);
                        break;
                    case 'Enter':
                        // Only handle Enter if a result is selected
                        if (selectedResultIndex >= 0) {
                            e.preventDefault();
                            navigateToSelected();
                        }
                        break;
                }
            }
        });
    }
})();
</script>

{{ partial "custom-head.html" . }}
